<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>リスナー評価実験</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .rating {
            margin: 10px 0;
        }

        .rating label {
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <h1>リスナー評価実験</h1>
    <input type="number" name="" id="number" placeholder="番号を入力(例:2805)" />
    <div id="experiment">
        <p id="theme"></p>
        <button id="playBtn">コード進行を再生</button>
        <div class="rating">
            <p>自然さ（1=不自然, 7=とても自然）</p>
            <div id="naturalness"></div>
        </div>
        <div class="rating">
            <p>テーマとの合致（1=全く合わない, 7=とても合う）</p>
            <div id="themeMatch"></div>
        </div>
        <button id="nextBtn">次へ</button>
    </div>
    <div id="results" class="hidden">
        <h2>結果</h2>
        <pre id="output"></pre>
    </div>

    <script>
        const data = [{
            number: 2809,
            theme: "悲しい",
            instrument: "midi",
            midi: [[60, 63, 67], [67 - 12, 71 - 12, 74 - 12, 77 - 12], [65 - 12, 68 - 12, 72 - 12], [67 - 12, 71 - 12, 74 - 12]]
        }, {
            number: 1805,
            theme: "穏やか",
            instrument: "midi",
            midi: [[62, 65, 69], [60, 64, 67], [62, 65, 69, 74], [62, 65, 74]]
        }, {
            number: 2801,
            theme: "怒り",
            instrument: "midi",
            midi: [
                [64, 69, 71, 73],
                [66, 60, 64, 67],
                [65, 69, 71, 72, 78],
                [67, 71, 73, 74]
            ]
        }, {
            number: 1805,
            theme: "穏やか",
            instrument: "fifth",
            midi: [
                [62, 66, 69, 72, 76], // D9
                [60, 64, 67],         // C
                [62, 66, 69],         // D
                [60, 64, 67],         // C
                [67, 71, 74],         // G
                [69, 73, 76],         // A
                [60, 64, 67]          // C
            ]
        }];

        // Fisher-Yates シャッフル
        function shuffle(array) {
            let arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        let trials = shuffle(data);
        let currentIndex = 0;
        let results = [];

        // 評価フォーム生成（1〜7のラジオボタン）
        function createRatingInputs(containerId, name) {
            const container = document.getElementById(containerId);
            for (let i = 1; i <= 7; i++) {
                let label = document.createElement("label");
                let input = document.createElement("input");
                input.type = "radio";
                input.name = name;
                input.value = i;
                label.appendChild(input);
                label.append(" " + i);
                container.appendChild(label);
            }
        }
        createRatingInputs("naturalness", "naturalness");
        createRatingInputs("themeMatch", "themeMatch");

        // 再生処理
        async function playChordProgression(midiChords) {
            await Tone.start();
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
            let now = Tone.now();
            let chordDuration = 1.5; // 各コードの長さ（秒）
            midiChords.forEach((chord, i) => {
                synth.triggerAttackRelease(chord.map(n => Tone.Frequency(n, "midi").toNote()), chordDuration, now + i * chordDuration);
            });
        }
        document.getElementById("number").addEventListener("change", (e) => {
            const inputNumber = parseInt(e.target.value, 10);
            if (isNaN(inputNumber)) {
                alert("有効な番号を入力してください");
                return;
            }

            // 入力された番号がdata内に存在するか確認
            const indexToSkip = trials.findIndex(trial => trial.number === inputNumber);
            if (indexToSkip !== -1) {
                trials.splice(indexToSkip, 1); // 該当のトライアルを削除
                if (currentIndex >= trials.length) {
                    // 全てのトライアルが終了した場合
                    document.getElementById("experiment").classList.add("hidden");
                    document.getElementById("results").classList.remove("hidden");
                    document.getElementById("output").textContent = JSON.stringify(results, null, 2);
                } else {
                    showTrial(); // 次のトライアルを表示
                }
            }
        });
        // 次のトライアルを表示
        function showTrial() {
            if (currentIndex >= trials.length) {
                document.getElementById("experiment").classList.add("hidden");
                document.getElementById("results").classList.remove("hidden");
                document.getElementById("output").textContent = JSON.stringify(results, null, 2);
                return;
            }
            let trial = trials[currentIndex];
            document.getElementById("theme").textContent = `テーマ: ${trial.theme} (ID:${trial.number})`;

            // ラジオボタンリセット
            document.querySelectorAll("input[type=radio]").forEach(r => r.checked = false);
        }

        // ボタンイベント
        document.getElementById("playBtn").addEventListener("click", () => {
            let trial = trials[currentIndex];
            playChordProgression(trial.midi);
        });

        document.getElementById("nextBtn").addEventListener("click", () => {
            let nat = document.querySelector("input[name=naturalness]:checked");
            let theme = document.querySelector("input[name=themeMatch]:checked");
            if (!nat || !theme) {
                alert("両方の評価を入力してください");
                return;
            }
            results.push({
                number: trials[currentIndex].number,
                theme: trials[currentIndex].theme,
                instrument: trials[currentIndex].instrument,
                naturalness: parseInt(nat.value),
                themeMatch: parseInt(theme.value)
            });
            currentIndex++;
            showTrial();
        });

        showTrial();
    </script>
</body>

</html>
